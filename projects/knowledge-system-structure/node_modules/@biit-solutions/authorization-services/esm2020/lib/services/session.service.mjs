import { Constants } from "../constants";
import { User } from "../models/user";
export class SessionService {
    constructor(authService, context = '') {
        this.authService = authService;
        this.context = context;
        this.loggedIn = false;
        const authToken = localStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`);
        const expires = +localStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`);
        let user = localStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`) ? User.clone(JSON.parse(localStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`))) : undefined;
        if (!user) {
            user = sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`) ? User.clone(JSON.parse(sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`))) : undefined;
        }
        this.user = user;
        if (!expires || isNaN(expires) || expires < new Date().getTime()) {
            localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`);
            localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`);
            localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`);
        }
        if (authToken) {
            sessionStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`, authToken);
            sessionStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`, JSON.stringify(user));
            this.store = true;
            if (expires && !isNaN(expires)) {
                sessionStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`, expires.toString());
            }
            this.loggedIn = true;
        }
        if ((authToken && expires)
            || (sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`) && sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`))) {
            this.setAutoRenew(authToken ? authToken : sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`), expires ? expires : +sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`));
        }
    }
    onTokenReceived(token, expiration, user) {
        this.setToken(token, expiration);
        this.setUser(user);
        console.log(`Token ${this.context ? 'for' + this.context : ''} has been renewed successfully.`, token);
    }
    onException(error) {
        console.error(`There was an exception while renewing the token ${this.context ? 'for' + this.context : ''}.`);
        this.clearToken();
    }
    setAutoRenew(token, expires) {
        // ADD HERE ALL SERVICES NEED TO BE CALLED TO RENEW TOKEN
        this.authService.autoRenewToken(token, expires, this);
    }
    clearToken() {
        sessionStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`);
        sessionStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`);
        sessionStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`);
        this.store = undefined;
        localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`);
        localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`);
        localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`);
        this.loggedIn = false;
        this.user = undefined;
    }
    setToken(token, expires, enableStore = undefined, autoRenew = false) {
        if (!token || !expires) {
            this.clearToken();
            return;
        }
        sessionStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`, token);
        sessionStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`, expires.toString());
        if (enableStore !== undefined) {
            this.store = enableStore;
            if (!enableStore) {
                localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`);
                localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`);
            }
        }
        if (this.store) {
            localStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`, token);
            localStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`, expires.toString());
        }
        if (autoRenew) {
            this.setAutoRenew(token, expires);
        }
        this.loggedIn = true;
    }
    getToken() {
        return sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_TOKEN}`);
    }
    isTokenExpired() {
        const expired = !sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`) ||
            new Date().getTime() > +sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`) || !this.getToken();
        if (!expired) {
            this.loggedIn = true;
        }
        return expired;
    }
    getExpirationDate() {
        const sessionExpiration = sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`);
        if (!isNaN(+sessionExpiration)) {
            return new Date(+sessionStorage.getItem(`${this.context}.${Constants.SESSION_STORAGE.AUTH_EXPIRATION}`));
        }
        return null;
    }
    get isLoggedIn() {
        return this.loggedIn;
    }
    setUser(user, enableStore = undefined) {
        sessionStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`, JSON.stringify(user));
        if (enableStore !== undefined) {
            if (!enableStore) {
                localStorage.removeItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`);
            }
        }
        if (this.store) {
            localStorage.setItem(`${this.context}.${Constants.SESSION_STORAGE.USER}`, JSON.stringify(user));
        }
        this.user = user;
    }
    getUser() {
        return this.user;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXV0aG9yaXphdGlvbi1zZXJ2aWNlcy9zcmMvbGliL3NlcnZpY2VzL3Nlc3Npb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBR3ZDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwQyxNQUFNLE9BQU8sY0FBYztJQUl6QixZQUFvQixXQUF3QixFQUFVLFVBQWtCLEVBQUU7UUFBdEQsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFhO1FBSGxFLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFJaEMsTUFBTSxTQUFTLEdBQVcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLElBQUksU0FBUyxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQzFHLE1BQU0sT0FBTyxHQUFXLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLElBQUksU0FBUyxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQzlHLElBQUksSUFBSSxHQUFTLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxJQUFJLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxJQUFJLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUMzTSxJQUFJLENBQUMsSUFB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RCxPQUFPO1FBQ0wsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29uc3RhbnRzfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQge0F1dGhTZXJ2aWNlfSBmcm9tIFwiLi9hdXRoLnNlcnZpY2VcIjtcbmltcG9ydCB7VG9rZW5SZW5ld0xpc3RlbmVyfSBmcm9tIFwiLi90b2tlbi1yZW5ld1wiO1xuaW1wb3J0IHtVc2VyfSBmcm9tIFwiLi4vbW9kZWxzL3VzZXJcIjtcblxuZXhwb3J0IGNsYXNzIFNlc3Npb25TZXJ2aWNlIGltcGxlbWVudHMgVG9rZW5SZW5ld0xpc3RlbmVyIHtcbiAgcHJpdmF0ZSBsb2dnZWRJbjogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIHVzZXI6IFVzZXI7XG4gIHByaXZhdGUgc3RvcmU6IGJvb2xlYW47XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlLCBwcml2YXRlIGNvbnRleHQ6IHN0cmluZyA9ICcnKSB7XG4gICAgY29uc3QgYXV0aFRva2VuOiBzdHJpbmcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX1RPS0VOfWApO1xuICAgIGNvbnN0IGV4cGlyZXM6IG51bWJlciA9ICtsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX0VYUElSQVRJT059YCk7XG4gICAgbGV0IHVzZXI6IFVzZXIgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5VU0VSfWApID8gVXNlci5jbG9uZShKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLlVTRVJ9YCkpKSA6IHVuZGVmaW5lZDtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHVzZXIgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLlVTRVJ9YCkgPyBVc2VyLmNsb25lKEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5VU0VSfWApKSkgOiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHRoaXMudXNlciA9IHVzZXI7XG4gICAgaWYgKCFleHBpcmVzIHx8IGlzTmFOKGV4cGlyZXMpIHx8IGV4cGlyZXMgPCBuZXcgRGF0ZSgpLmdldFRpbWUoKSkge1xuICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9UT0tFTn1gKTtcbiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfRVhQSVJBVElPTn1gKTtcbiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLlVTRVJ9YCk7XG4gICAgfVxuICAgIGlmIChhdXRoVG9rZW4pIHtcbiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9UT0tFTn1gLCBhdXRoVG9rZW4pO1xuICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5VU0VSfWAsIEpTT04uc3RyaW5naWZ5KHVzZXIpKTtcbiAgICAgIHRoaXMuc3RvcmUgPSB0cnVlO1xuICAgICAgaWYgKGV4cGlyZXMgJiYgIWlzTmFOKGV4cGlyZXMpKSB7XG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9FWFBJUkFUSU9OfWAsIGV4cGlyZXMudG9TdHJpbmcoKSk7XG4gICAgICB9XG4gICAgICB0aGlzLmxvZ2dlZEluID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKChhdXRoVG9rZW4gJiYgZXhwaXJlcylcbiAgICAgIHx8IChzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfVE9LRU59YCkgJiYgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX0VYUElSQVRJT059YCkpKSB7XG4gICAgICB0aGlzLnNldEF1dG9SZW5ldyhhdXRoVG9rZW4/IGF1dGhUb2tlbiA6IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9UT0tFTn1gKVxuICAgICAgICAsIGV4cGlyZXMgPyBleHBpcmVzIDogK3Nlc3Npb25TdG9yYWdlLmdldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9FWFBJUkFUSU9OfWApKTtcbiAgICB9XG4gIH1cblxuICBvblRva2VuUmVjZWl2ZWQodG9rZW46IHN0cmluZywgZXhwaXJhdGlvbjogbnVtYmVyLCB1c2VyOiBVc2VyKTogdm9pZCB7XG4gICAgdGhpcy5zZXRUb2tlbih0b2tlbiwgZXhwaXJhdGlvbik7XG4gICAgdGhpcy5zZXRVc2VyKHVzZXIpO1xuICAgIGNvbnNvbGUubG9nKGBUb2tlbiAke3RoaXMuY29udGV4dCA/ICdmb3InICsgdGhpcy5jb250ZXh0IDogJyd9IGhhcyBiZWVuIHJlbmV3ZWQgc3VjY2Vzc2Z1bGx5LmAsIHRva2VuKTtcbiAgfVxuICBvbkV4Y2VwdGlvbihlcnJvcjogYW55KTogdm9pZCB7XG4gICAgY29uc29sZS5lcnJvcihgVGhlcmUgd2FzIGFuIGV4Y2VwdGlvbiB3aGlsZSByZW5ld2luZyB0aGUgdG9rZW4gJHt0aGlzLmNvbnRleHQgPyAnZm9yJyArIHRoaXMuY29udGV4dCA6ICcnfS5gKTtcbiAgICB0aGlzLmNsZWFyVG9rZW4oKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0QXV0b1JlbmV3KHRva2VuOiBzdHJpbmcsIGV4cGlyZXM6IG51bWJlcik6IHZvaWQge1xuICAgIC8vIEFERCBIRVJFIEFMTCBTRVJWSUNFUyBORUVEIFRPIEJFIENBTExFRCBUTyBSRU5FVyBUT0tFTlxuICAgIHRoaXMuYXV0aFNlcnZpY2UuYXV0b1JlbmV3VG9rZW4odG9rZW4sIGV4cGlyZXMsIHRoaXMpO1xuICB9XG5cbiAgY2xlYXJUb2tlbigpOiB2b2lkIHtcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfVE9LRU59YCk7XG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX0VYUElSQVRJT059YCk7XG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5VU0VSfWApO1xuICAgIHRoaXMuc3RvcmUgPSB1bmRlZmluZWQ7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9UT0tFTn1gKTtcbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX0VYUElSQVRJT059YCk7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuVVNFUn1gKTtcbiAgICB0aGlzLmxvZ2dlZEluID0gZmFsc2U7XG4gICAgdGhpcy51c2VyID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgc2V0VG9rZW4odG9rZW46IHN0cmluZywgZXhwaXJlczogbnVtYmVyLCBlbmFibGVTdG9yZTogYm9vbGVhbiA9IHVuZGVmaW5lZCwgYXV0b1JlbmV3OiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcbiAgICBpZiAoIXRva2VuIHx8ICFleHBpcmVzKSB7XG4gICAgICB0aGlzLmNsZWFyVG9rZW4oKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX1RPS0VOfWAsIHRva2VuKTtcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfRVhQSVJBVElPTn1gLCBleHBpcmVzLnRvU3RyaW5nKCkpO1xuICAgIGlmIChlbmFibGVTdG9yZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnN0b3JlID0gZW5hYmxlU3RvcmU7XG4gICAgICBpZiAoIWVuYWJsZVN0b3JlKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfVE9LRU59YCk7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfRVhQSVJBVElPTn1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuc3RvcmUpIHtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfVE9LRU59YCwgdG9rZW4pO1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9FWFBJUkFUSU9OfWAsIGV4cGlyZXMudG9TdHJpbmcoKSk7XG4gICAgfVxuICAgIGlmIChhdXRvUmVuZXcpIHtcbiAgICAgIHRoaXMuc2V0QXV0b1JlbmV3KHRva2VuLCBleHBpcmVzKTtcbiAgICB9XG4gICAgdGhpcy5sb2dnZWRJbiA9IHRydWU7XG4gIH1cblxuICBnZXRUb2tlbigpOiBzdHJpbmcge1xuICAgIHJldHVybiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfVE9LRU59YCk7XG4gIH1cblxuICBpc1Rva2VuRXhwaXJlZCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBleHBpcmVkOiBib29sZWFuID0gIXNlc3Npb25TdG9yYWdlLmdldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9FWFBJUkFUSU9OfWApIHx8XG4gICAgICBuZXcgRGF0ZSgpLmdldFRpbWUoKSA+ICtzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLkFVVEhfRVhQSVJBVElPTn1gKSB8fCAhdGhpcy5nZXRUb2tlbigpO1xuICAgIGlmICghZXhwaXJlZCkge1xuICAgICAgdGhpcy5sb2dnZWRJbiA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBleHBpcmVkO1xuICB9XG4gIGdldEV4cGlyYXRpb25EYXRlKCk6IERhdGUge1xuICAgIGNvbnN0IHNlc3Npb25FeHBpcmF0aW9uID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5BVVRIX0VYUElSQVRJT059YCk7XG4gICAgaWYgKCFpc05hTigrc2Vzc2lvbkV4cGlyYXRpb24pKSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUoK3Nlc3Npb25TdG9yYWdlLmdldEl0ZW0oYCR7dGhpcy5jb250ZXh0fS4ke0NvbnN0YW50cy5TRVNTSU9OX1NUT1JBR0UuQVVUSF9FWFBJUkFUSU9OfWApKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBnZXQgaXNMb2dnZWRJbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5sb2dnZWRJbjtcbiAgfVxuXG4gIHNldFVzZXIodXNlcjogVXNlciwgZW5hYmxlU3RvcmU6IGJvb2xlYW4gPSB1bmRlZmluZWQpOiB2b2lkIHtcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLlVTRVJ9YCwgSlNPTi5zdHJpbmdpZnkodXNlcikpO1xuICAgIGlmIChlbmFibGVTdG9yZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAoIWVuYWJsZVN0b3JlKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGAke3RoaXMuY29udGV4dH0uJHtDb25zdGFudHMuU0VTU0lPTl9TVE9SQUdFLlVTRVJ9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnN0b3JlKSB7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShgJHt0aGlzLmNvbnRleHR9LiR7Q29uc3RhbnRzLlNFU1NJT05fU1RPUkFHRS5VU0VSfWAsIEpTT04uc3RyaW5naWZ5KHVzZXIpKTtcbiAgICB9XG4gICAgdGhpcy51c2VyID0gdXNlcjtcbiAgfVxuXG4gIGdldFVzZXIoKTogVXNlciB7XG4gICAgcmV0dXJuIHRoaXMudXNlcjtcbiAgfVxuXG59XG4iXX0=